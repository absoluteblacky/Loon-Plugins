// åº“è¡—åŒºè‡ªåŠ¨ç­¾åˆ°æ’ä»¶
const appName = 'åº“è¡—åŒº';
const cookieKey = 'kujie_cookies';
const apiKey = 'kujie_api';

// è‡ªåŠ¨æ•è·Cookieå’ŒAPI
const getCookie = typeof $request !== 'undefined' ? {
    url: $request.url,
    cookie: $request.headers['Cookie'] || $request.headers['cookie']
} : null;

if (getCookie) {
    // è‡ªåŠ¨æ•è·APIåœ°å€
    if ($request.url.includes('sign') || $request.url.includes('checkin')) {
        $persistentStore.write($request.url, apiKey);
        console.log(`APIåœ°å€å·²æ›´æ–°ï¼š${$request.url}`);
    }
    
    // æ•è·Cookie
    const storedCookies = $persistentStore.read(cookieKey) ? JSON.parse($persistentStore.read(cookieKey)) : {};
    const accountId = $request.headers['X-User-Id'] || Date.now(); // ä½¿ç”¨ç”¨æˆ·IDæˆ–æ—¶é—´æˆ³ä½œä¸ºè´¦å·æ ‡è¯†
    
    storedCookies[accountId] = {
        cookie: getCookie.cookie,
        expire: Date.now() + 86400*1000 // å‡è®¾Cookieæœ‰æ•ˆæœŸ1å¤©
    };
    
    $persistentStore.write(JSON.stringify(storedCookies), cookieKey);
    $notification.post(appName, 'Cookieå·²è‡ªåŠ¨è·å–', `è´¦å·${accountId}æ›´æ–°æˆåŠŸ`);
    $done();
}

// ä¸»åŠŸèƒ½
function main() {
    const apiURL = $persistentStore.read(apiKey);
    const cookies = JSON.parse($persistentStore.read(cookieKey));
    
    if (!apiURL || !cookies) {
        $notification.post(appName, 'é…ç½®ä¸å®Œæ•´', 'è¯·å…ˆæ‰“å¼€APPå®Œæˆè‡ªåŠ¨é…ç½®');
        return;
    }

    Object.entries(cookies).forEach(([accountId, accountData]) => {
        if (Date.now() > accountData.expire) {
            $notification.post(appName, 'Cookieå·²è¿‡æœŸ', `è´¦å·${accountId}éœ€è¦é‡æ–°ç™»å½•`);
            return;
        }

        const request = {
            url: apiURL,
            headers: {
                'Cookie': accountData.cookie,
                'User-Agent': 'KuJie/2.1.0 (com.kujie.app; build:2024; iOS 16.4)'
            }
        };

        $httpClient.post(request, (error, response, data) => {
            let result = '';
            try {
                result = JSON.parse(data);
            } catch (e) {
                console.log('è§£æå“åº”å¤±è´¥');
            }
            
            const msg = result.success ? 
                `ğŸ‰ æˆåŠŸ | ç§¯åˆ†+${result.data?.points || 0}` : 
                `âŒ å¤±è´¥ | ${result.message || 'æœªçŸ¥é”™è¯¯'}`;
            
            $notification.post(`${appName} ç­¾åˆ°`, `è´¦å·${accountId}`, msg);
        });
    });
}

// é…ç½®æ£€æŸ¥
if (typeof $argument !== 'undefined') {
    // å¿«æ·èœå•
    const menu = [
        { title: "ğŸ“¦ æ›´æ–°é…ç½®", action: "updateConfig" },
        { title: "âœ… æµ‹è¯•ç­¾åˆ°", action: "testSign" },
        { title: "ğŸ§¹ æ¸…é™¤ç¼“å­˜", action: "clearCache" }
    ];
    
    const panel = {
        title: appName + "ç®¡ç†é¢æ¿",
        content: `å·²å­˜å‚¨è´¦å·æ•°ï¼š${Object.keys(JSON.parse($persistentStore.read(cookieKey) || '{}')).length}\nå½“å‰APIï¼š${$persistentStore.read(apiKey) || 'æœªé…ç½®'}`,
        menu: JSON.stringify(menu)
    };
    
    $done(panel);
} else {
    main();
}
