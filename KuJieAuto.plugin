// æ’ä»¶åç§°: åº“è¡—åŒºè‡ªåŠ¨ç­¾åˆ°
// åŠŸèƒ½: è‡ªåŠ¨æ•è·Cookieã€APIåœ°å€ï¼Œæ”¯æŒå¤šè´¦å·å’Œå¤±è´¥é‡è¯•
// ä½œè€…: DeepSeek-R1
// ç‰ˆæœ¬: 2.0
// æ—¥æœŸ: 2024-02-16

const PLUGIN_NAME = "åº“è¡—åŒºç­¾åˆ°";
const COOKIE_KEY = "kuro_cookies";
const API_KEY = "kuro_api";
const MAX_RETRY = 3;
const RETRY_DELAY = 2000;

// æ ¸å¿ƒé€»è¾‘
if (typeof $request !== "undefined") {
  handleRequestCapture();
} else {
  executeSignIn();
}

// æ•è·è¯·æ±‚
function handleRequestCapture() {
  const url = $request.url;
  const cookie = $request.headers?.Cookie || $request.headers?.cookie;

  // æ•è·Cookie
  if (cookie) {
    const accountId = extractAccountId(cookie, url);
    updateCookieStore(accountId, cookie);
    console.log(`âœ… è´¦å· ${accountId} Cookieå·²æ›´æ–°`);
  }

  // æ•è·APIåœ°å€
  if (url.includes("sign") || url.includes("checkin")) {
    $persistentStore.write(url, API_KEY);
    console.log(`ğŸ”— APIåœ°å€å·²æ›´æ–°: ${url}`);
  }

  $done();
}

// æ‰§è¡Œç­¾åˆ°
function executeSignIn() {
  const apiURL = $persistentStore.read(API_KEY);
  const cookies = JSON.parse($persistentStore.read(COOKIE_KEY) || "{}");

  if (!apiURL || Object.keys(cookies).length === 0) {
    notifyUser("æœªé…ç½®APIæˆ–Cookie", "è¯·æ‰“å¼€åº“è¡—åŒºAPPå®Œæˆè‡ªåŠ¨é…ç½®");
    return;
  }

  for (const [accountId, data] of Object.entries(cookies)) {
    if (isCookieExpired(data.expire)) {
      notifyUser(`è´¦å· ${accountId} Cookieå·²è¿‡æœŸ`, "è¯·é‡æ–°ç™»å½•");
      continue;
    }
    attemptSignIn(apiURL, data.cookie, accountId, MAX_RETRY);
  }
}

// å·¥å…·å‡½æ•°
function extractAccountId(cookie, url) {
  const idFromCookie = cookie.match(/user_id=(\d+)/)?.[1];
  const idFromURL = url.match(/user_id=(\d+)/)?.[1];
  return idFromCookie || idFromURL || Date.now().toString();
}

function updateCookieStore(accountId, cookie) {
  const stored = JSON.parse($persistentStore.read(COOKIE_KEY) || "{}");
  stored[accountId] = { 
    cookie: cookie, 
    expire: Date.now() + 86400000, // 24å°æ—¶æœ‰æ•ˆæœŸ
    updated: new Date().toISOString()
  };
  $persistentStore.write(JSON.stringify(stored), COOKIE_KEY);
}

function isCookieExpired(expireTime) {
  return Date.now() > parseInt(expireTime);
}

function attemptSignIn(apiURL, cookie, accountId, retries) {
  const request = {
    url: apiURL,
    headers: { 
      "Cookie": cookie,
      "User-Agent": "KuJie/2.1.0 (com.kurobbs.app; build:2024; iOS 17.2)"
    }
  };

  $httpClient.post(request, (error, response, data) => {
    if (error) {
      handleRetry(error, apiURL, cookie, accountId, retries);
      return;
    }
    parseSignInResult(data, accountId);
  });
}

function handleRetry(error, apiURL, cookie, accountId, retries) {
  if (retries > 0) {
    console.log(`â³ è´¦å· ${accountId} é‡è¯•ä¸­ (å‰©ä½™æ¬¡æ•°: ${retries})`);
    setTimeout(() => attemptSignIn(apiURL, cookie, accountId, retries - 1), RETRY_DELAY);
  } else {
    notifyUser(`è´¦å· ${accountId} ç­¾åˆ°å¤±è´¥`, error.localizedDescription || "æœªçŸ¥ç½‘ç»œé”™è¯¯");
  }
}

function parseSignInResult(data, accountId) {
  try {
    const result = JSON.parse(data);
    if (result?.code === 200) {
      notifyUser(`è´¦å· ${accountId} ç­¾åˆ°æˆåŠŸ`, `è·å¾—ç§¯åˆ†: ${result.data?.points || "æœªçŸ¥"}`);
    } else {
      notifyUser(`è´¦å· ${accountId} ç­¾åˆ°å¤±è´¥`, result?.msg || "æœåŠ¡å™¨è¿”å›å¼‚å¸¸");
    }
  } catch (e) {
    notifyUser(`è´¦å· ${accountId} æ•°æ®è§£æå¤±è´¥`, e.message);
  }
}

function notifyUser(title, message) {
  $notification.post(PLUGIN_NAME, title, message);
}

// ç®¡ç†é¢æ¿
if (typeof $argument !== "undefined") {
  const menu = [
    { title: "ğŸ“¡ æ‰‹åŠ¨æ›´æ–°é…ç½®", action: "updateConfig" },
    { title: "ğŸ”„ ç«‹å³æ‰§è¡Œç­¾åˆ°", action: "forceSignIn" }
  ];
  $done({
    title: `${PLUGIN_NAME} æ§åˆ¶å°`,
    content: `å·²å­˜å‚¨è´¦å·: ${Object.keys(JSON.parse($persistentStore.read(COOKIE_KEY) || "{}")).length}\nå½“å‰API: ${$persistentStore.read(API_KEY) || "æœªé…ç½®"}`,
    menu: JSON.stringify(menu)
  });
}
