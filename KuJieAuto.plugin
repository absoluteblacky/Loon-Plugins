// æ’ä»¶åç§°ï¼šåº“è¡—åŒºè‡ªåŠ¨ç­¾åˆ°
// åŠŸèƒ½æè¿°ï¼šè‡ªåŠ¨å®Œæˆåº“è¡—åŒºæ¯æ—¥ç­¾åˆ°ï¼Œæ”¯æŒå¤šè´¦å·ã€è‡ªåŠ¨è·å–Cookieå’ŒAPIåœ°å€
// ä½œè€…ï¼šabsoluteblacky
// ç‰ˆæœ¬ï¼š1.1.0
// æ›´æ–°æ—¶é—´ï¼š2023-10-01

// å¸¸é‡å®šä¹‰
const pluginName = "åº“è¡—åŒºç­¾åˆ°";
const cookieKey = "kujie_cookies"; // å­˜å‚¨Cookieçš„é”®å
const apiKey = "kujie_api"; // å­˜å‚¨APIåœ°å€çš„é”®å
const retryCount = 3; // å¤±è´¥é‡è¯•æ¬¡æ•°
const retryDelay = 2000; // é‡è¯•å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰

// è‡ªåŠ¨æ•è·Cookieå’ŒAPIåœ°å€
if (typeof $request !== "undefined") {
    const url = $request.url;
    const cookie = $request.headers["Cookie"] || $request.headers["cookie"];

    if (cookie) {
        // è·å–è´¦å·IDï¼ˆä»Cookieæˆ–URLä¸­æå–ï¼‰
        const accountId = getAccountId(cookie, url);

        // è¯»å–å·²å­˜å‚¨çš„Cookie
        const storedCookies = $persistentStore.read(cookieKey) ? JSON.parse($persistentStore.read(cookieKey)) : {};

        // æ›´æ–°Cookie
        storedCookies[accountId] = {
            cookie: cookie,
            expire: Date.now() + 86400 * 1000, // Cookieæœ‰æ•ˆæœŸ1å¤©
            lastUpdate: new Date().toLocaleString()
        };

        // ä¿å­˜Cookie
        $persistentStore.write(JSON.stringify(storedCookies), cookieKey);
        console.log(`è´¦å· ${accountId} çš„Cookieå·²æ›´æ–°`);
    }

    // æ•è·APIåœ°å€
    if (url.includes("sign") || url.includes("checkin")) {
        $persistentStore.write(url, apiKey);
        console.log(`APIåœ°å€å·²æ›´æ–°ï¼š${url}`);
    }

    $done();
}

// ä¸»å‡½æ•°
function main() {
    const apiURL = $persistentStore.read(apiKey);
    const cookies = $persistentStore.read(cookieKey) ? JSON.parse($persistentStore.read(cookieKey)) : {};

    if (!apiURL) {
        $notification.post(pluginName, "æœªé…ç½®APIåœ°å€", "è¯·å…ˆæ‰“å¼€åº“è¡—åŒºAPPå®Œæˆè‡ªåŠ¨é…ç½®");
        return;
    }

    if (Object.keys(cookies).length === 0) {
        $notification.post(pluginName, "æœªé…ç½®Cookie", "è¯·å…ˆæ‰“å¼€åº“è¡—åŒºAPPå®Œæˆè‡ªåŠ¨é…ç½®");
        return;
    }

    // éå†æ‰€æœ‰è´¦å·
    for (const [accountId, accountData] of Object.entries(cookies)) {
        if (Date.now() > accountData.expire) {
            $notification.post(pluginName, `è´¦å· ${accountId} Cookieå·²è¿‡æœŸ`, "è¯·é‡æ–°ç™»å½•");
            continue;
        }

        // æ‰§è¡Œç­¾åˆ°
        signIn(apiURL, accountData.cookie, accountId, retryCount);
    }
}

// ç­¾åˆ°å‡½æ•°
function signIn(apiURL, cookie, accountId, retries) {
    const request = {
        url: apiURL,
        headers: {
            "Cookie": cookie,
            "User-Agent": "KuJie/2.1.0 (com.kujie.app; build:2024; iOS 16.4)"
        }
    };

    $httpClient.post(request, (error, response, data) => {
        if (error) {
            if (retries > 0) {
                console.log(`è´¦å· ${accountId} ç­¾åˆ°å¤±è´¥ï¼Œå‰©ä½™é‡è¯•æ¬¡æ•°ï¼š${retries}`);
                setTimeout(() => signIn(apiURL, cookie, accountId, retries - 1), retryDelay);
            } else {
                $notification.post(pluginName, `è´¦å· ${accountId} ç­¾åˆ°å¤±è´¥`, error);
            }
            return;
        }

        try {
            const result = JSON.parse(data);
            if (result.success) {
                $notification.post(pluginName, `è´¦å· ${accountId} ç­¾åˆ°æˆåŠŸ`, `è·å¾—ç§¯åˆ†ï¼š${result.data?.points || 0}`);
            } else {
                $notification.post(pluginName, `è´¦å· ${accountId} ç­¾åˆ°å¤±è´¥`, result.message || "æœªçŸ¥é”™è¯¯");
            }
        } catch (e) {
            $notification.post(pluginName, `è´¦å· ${accountId} è§£æå“åº”å¤±è´¥`, e);
        }
    });
}

// è·å–è´¦å·ID
function getAccountId(cookie, url) {
    // ä»Cookieä¸­æå–è´¦å·ID
    const match = cookie.match(/user_id=(\d+)/);
    if (match) return match;

    // ä»URLä¸­æå–è´¦å·ID
    const urlMatch = url.match(/user_id=(\d+)/);
    if (urlMatch) return urlMatch;

    // å¦‚æœæœªæ‰¾åˆ°ï¼Œä½¿ç”¨æ—¶é—´æˆ³ä½œä¸ºå”¯ä¸€æ ‡è¯†
    return Date.now();
}

// æ’ä»¶å…¥å£
if (typeof $argument !== "undefined") {
    // å¿«æ·èœå•
    const menu = [
        { title: "ğŸ“¦ æ›´æ–°é…ç½®", action: "updateConfig" },
        { title: "âœ… æµ‹è¯•ç­¾åˆ°", action: "testSign" },
        { title: "ğŸ§¹ æ¸…é™¤ç¼“å­˜", action: "clearCache" }
    ];

    const panel = {
        title: pluginName + "ç®¡ç†é¢æ¿",
        content: `å·²å­˜å‚¨è´¦å·æ•°ï¼š${Object.keys(JSON.parse($persistentStore.read(cookieKey) || "{}")).length}\nå½“å‰APIï¼š${$persistentStore.read(apiKey) || "æœªé…ç½®"}`,
        menu: JSON.stringify(menu)
    };

    $done(panel);
} else {
    // æ­£å¸¸æ‰§è¡Œä¸»å‡½æ•°
    main();
}
